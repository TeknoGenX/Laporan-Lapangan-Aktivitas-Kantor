<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard Monitoring</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-brand-600 text-white p-2 rounded-lg">
                        <i class="ph ph-chart-line-up text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900 tracking-tight">Sistem Monitoring</h1>
                        <p class="text-xs text-slate-500">Laporan Lapangan & Aktivitas Kantor</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden md:block">
                        <p class="text-sm font-medium text-slate-900" id="current-date"></p>
                        <p class="text-xs text-slate-500">Status: Online</p>
                    </div>
                    <div class="h-8 w-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-600">
                        <i class="ph ph-user font-bold"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-8 flex flex-col lg:flex-row justify-between items-end lg:items-center gap-4">
            
            <form method="GET" class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
                <div class="relative group">
                    <label class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">Tanggal Mulai</label>
                    <div class="flex items-center border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 group-focus-within:ring-2 ring-brand-500 transition">
                        <i class="ph ph-calendar-blank text-slate-400 mr-2"></i>
                        <input type="date" name="start_date" class="bg-transparent border-none outline-none text-sm w-full text-slate-700" value="{{ request.GET.start_date }}">
                    </div>
                </div>
                <div class="relative group">
                    <label class="block text-xs font-semibold text-slate-500 mb-1 uppercase tracking-wider">Tanggal Akhir</label>
                    <div class="flex items-center border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 group-focus-within:ring-2 ring-brand-500 transition">
                        <i class="ph ph-calendar-blank text-slate-400 mr-2"></i>
                        <input type="date" name="end_date" class="bg-transparent border-none outline-none text-sm w-full text-slate-700" value="{{ request.GET.end_date }}">
                    </div>
                </div>
                <div class="pb-0.5 sm:pb-0 flex items-end">
                    <button type="submit" class="h-[42px] bg-brand-600 text-white px-5 rounded-lg hover:bg-brand-700 font-medium text-sm transition shadow-lg shadow-brand-500/30 flex items-center gap-2">
                        <i class="ph ph-funnel"></i> Filter
                    </button>
                </div>
            </form>

            <div class="flex gap-3 w-full lg:w-auto justify-end border-t lg:border-t-0 pt-4 lg:pt-0 border-slate-100">
                <a href="{% url 'input_laporan' %}" class="h-[42px] bg-slate-800 text-white px-5 rounded-lg hover:bg-slate-900 font-medium text-sm transition flex items-center gap-2 shadow-lg shadow-slate-500/30">
                    <i class="ph ph-plus-circle text-lg"></i>
                    <span>Input Baru</span>
                </a>
                
                <div class="flex bg-slate-100 rounded-lg p-1">
                    <button onclick="generatePDF()" id="btn-export-pdf" class="px-4 py-1.5 rounded-md text-sm font-medium text-slate-600 hover:bg-white hover:text-red-600 hover:shadow-sm transition flex items-center gap-2">
                        <i class="ph ph-file-pdf"></i> PDF
                    </button>
                    <div class="w-px bg-slate-300 my-1"></div>
                    <button onclick="generateExcel()" id="btn-export-excel" class="px-4 py-1.5 rounded-md text-sm font-medium text-slate-600 hover:bg-white hover:text-emerald-600 hover:shadow-sm transition flex items-center gap-2">
                        <i class="ph ph-file-xls"></i> Excel
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-8">
            <div class="flex items-center gap-2 mb-4">
                <i class="ph ph-chart-pie-slice text-brand-600 text-xl"></i>
                <h2 class="text-lg font-bold text-slate-800">Analisis Performa</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Tren Laporan</h3>
                        <span class="bg-blue-50 text-blue-600 text-xs px-2 py-1 rounded-full font-medium">Harian</span>
                    </div>
                    <div class="h-48 relative"><canvas id="reportsDailyChart"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Waktu Sibuk</h3>
                        <span class="bg-emerald-50 text-emerald-600 text-xs px-2 py-1 rounded-full font-medium">Jam</span>
                    </div>
                    <div class="h-48 relative"><canvas id="reportsHourlyChart"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Distribusi Status</h3>
                        <span class="bg-purple-50 text-purple-600 text-xs px-2 py-1 rounded-full font-medium">Total</span>
                    </div>
                    <div class="h-48 relative"><canvas id="reportsByStatusChart"></canvas></div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Aktivitas Kantor</h3>
                        <span class="bg-indigo-50 text-indigo-600 text-xs px-2 py-1 rounded-full font-medium">Harian</span>
                    </div>
                    <div class="h-48 relative"><canvas id="activitiesDailyChart"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Jam Efektif</h3>
                        <span class="bg-amber-50 text-amber-600 text-xs px-2 py-1 rounded-full font-medium">Jam</span>
                    </div>
                    <div class="h-48 relative"><canvas id="activitiesHourlyChart"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide">Top Staff</h3>
                        <span class="bg-rose-50 text-rose-600 text-xs px-2 py-1 rounded-full font-medium">Performa</span>
                    </div>
                    <div class="h-48 relative"><canvas id="activitiesByStaffChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[500px]">
            
            <div class="border-b border-slate-200 bg-slate-50 px-6 py-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex bg-slate-200/50 p-1 rounded-lg">
                    <button id="tab-lapangan" onclick="switchTab('lapangan')" class="px-6 py-2 rounded-md text-sm font-semibold shadow-sm bg-white text-brand-600 transition-all duration-300">
                        <i class="ph ph-truck mr-1"></i> Laporan Lapangan
                    </button>
                    <button id="tab-kantor" onclick="switchTab('kantor')" class="px-6 py-2 rounded-md text-sm font-semibold text-slate-500 hover:text-slate-700 transition-all duration-300">
                        <i class="ph ph-buildings mr-1"></i> Aktivitas Kantor
                    </button>
                </div>
                <div class="text-xs text-slate-500 font-medium">
                    Menampilkan data terbaru
                </div>
            </div>

            <div class="p-6 bg-slate-50/30">
                
                <div id="content-lapangan" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                    {% for item in laporan_lapangan %}
                    <div class="bg-white rounded-xl border border-slate-200 p-0 overflow-hidden card-hover transition-all duration-300 flex flex-col h-full">
                        <div class="p-4 border-b border-slate-50 flex justify-between items-start bg-gradient-to-r from-white to-slate-50">
                            <div>
                                <h4 class="font-bold text-slate-800 text-base leading-tight">{{ item.nama_tim }}</h4>
                                <p class="text-xs text-slate-500 mt-1 flex items-center gap-1">
                                    <i class="ph ph-user"></i> {{ item.penerima }}
                                </p>
                            </div>
                            <span class="px-2.5 py-1 text-[10px] uppercase tracking-wide rounded-full font-bold
                                {% if item.status == 'Approved' %}bg-green-100 text-green-700 border border-green-200
                                {% elif item.status == 'Rejected' %}bg-red-100 text-red-700 border border-red-200
                                {% else %}bg-amber-100 text-amber-700 border border-amber-200{% endif %}">
                                {{ item.status }}
                            </span>
                        </div>

                        <div class="p-4 flex-grow">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded font-medium">
                                    <i class="ph ph-map-pin mr-1"></i>{{ item.jarak_km }} KM
                                </span>
                                <span class="bg-slate-100 text-slate-600 text-xs px-2 py-1 rounded font-medium">
                                    <i class="ph ph-clock mr-1"></i>{{ item.tanggal|date:"H:i" }}
                                </span>
                            </div>
                            <p class="text-sm text-slate-600 leading-relaxed line-clamp-3 mb-3">{{ item.keterangan }}</p>
                            
                            {% if item.foto_bukti.first %}
                            <div class="w-full h-32 rounded-lg overflow-hidden relative group border border-slate-200">
                                <img src="{{ item.foto_bukti.first.gambar.url }}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                            </div>
                            {% endif %}
                        </div>

                        <div class="px-4 py-3 bg-slate-50 border-t border-slate-100 flex justify-between items-center text-xs text-slate-400">
                            <span>ID: #{{ item.id }}</span>
                            <span>{{ item.tanggal|date:"d M Y" }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-400">
                        <i class="ph ph-clipboard-text text-6xl mb-4 text-slate-300"></i>
                        <p class="text-lg font-medium text-slate-500">Tidak ada data ditemukan</p>
                        <p class="text-sm">Coba ubah filter tanggal atau buat laporan baru.</p>
                    </div>
                    {% endfor %}
                </div>

                <div id="content-kantor" class="hidden grid grid-cols-1 md:grid-cols-2 gap-5">
                    {% for item in laporan_kantor %}
                    <div class="bg-white rounded-xl border border-slate-200 p-4 card-hover transition-all flex gap-5 items-start">
                        <div class="w-24 h-24 rounded-lg overflow-hidden border border-slate-200 flex-shrink-0 bg-slate-100">
                            {% if item.foto_hasil %}
                            <img src="{{ item.foto_hasil.url }}" class="w-full h-full object-cover">
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center text-slate-300">
                                <i class="ph ph-image text-2xl"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-slate-800 text-lg">{{ item.nama_staf }}</h4>
                                <span class="text-xs font-mono text-slate-400">{{ item.tanggal|date:"H:i" }}</span>
                            </div>
                            <p class="text-sm text-slate-600 mt-2 leading-relaxed">{{ item.deskripsi }}</p>
                            <div class="mt-4 pt-3 border-t border-slate-100 text-xs text-slate-400">
                                {{ item.tanggal|date:"d F Y" }}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-slate-400">
                        <p>Belum ada laporan aktivitas kantor.</p>
                    </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>

    <script>
        // Tanggal Header
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', options);

        // Data Prep (Sumber data tunggal untuk Chart, PDF, dan Excel)
        const rawData = [
            {% for item in laporan_lapangan %}
            {
                id: "{{ item.id }}",
                tim: "{{ item.nama_tim }}",
                penerima: "{{ item.penerima }}",
                jarak: "{{ item.jarak_km }}",
                status: "{{ item.status }}",
                keterangan: "{{ item.keterangan|escapejs }}",
                tanggal: "{{ item.tanggal|date:'d/m/Y H:i' }}",
                // URL Foto lengkap untuk kebutuhan fetch Excel/PDF
                fotoUrl: "{% if item.foto_bukti.first %}{{ request.scheme }}://{{ request.get_host }}{{ item.foto_bukti.first.gambar.url }}{% endif %}"
            },
            {% endfor %}
        ];

        // Tab Switching UI Logic
        function switchTab(tabName) {
            const contentLap = document.getElementById('content-lapangan');
            const contentKan = document.getElementById('content-kantor');
            const btnLap = document.getElementById('tab-lapangan');
            const btnKan = document.getElementById('tab-kantor');

            if(tabName === 'lapangan') {
                contentLap.classList.remove('hidden'); contentKan.classList.add('hidden');
                btnLap.classList.add('bg-white', 'text-brand-600', 'shadow-sm'); btnLap.classList.remove('text-slate-500');
                btnKan.classList.remove('bg-white', 'text-brand-600', 'shadow-sm'); btnKan.classList.add('text-slate-500');
            } else {
                contentLap.classList.add('hidden'); contentKan.classList.remove('hidden');
                btnKan.classList.add('bg-white', 'text-brand-600', 'shadow-sm'); btnKan.classList.remove('text-slate-500');
                btnLap.classList.remove('bg-white', 'text-brand-600', 'shadow-sm'); btnLap.classList.add('text-slate-500');
            }
        }

        // --- CHART LOGIC (6 CHARTS) ---
        window.reportsDailyChart = null; window.reportsHourlyChart = null; window.reportsByStatusChart = null;
        window.activitiesDailyChart = null; window.activitiesHourlyChart = null; window.activitiesByStaffChart = null;

        function createChart(canvasId, type, labels, data, labelName, colorInfo) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            let bg, border;
            if (Array.isArray(colorInfo)) { bg = colorInfo; border = colorInfo; } 
            else { bg = colorInfo; border = colorInfo.replace('0.2', '1').replace('0.6', '1'); }
            return new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: [{ label: labelName, data: data, backgroundColor: bg, borderColor: border, borderWidth: 2, fill: type === 'line', tension: 0.4, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'pie' || type === 'doughnut', position: 'bottom' } }, scales: (type === 'pie' || type === 'doughnut') ? {} : { y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f3f4f6' } }, x: { grid: { display: false } } }, layout: { padding: 10 } }
            });
        }

        fetch('/api/chart-data/' + window.location.search)
            .then(response => response.json())
            .then(data => {
                if (!data || !data.reports) return;
                if (window.reportsDailyChart) window.reportsDailyChart.destroy(); if (window.reportsHourlyChart) window.reportsHourlyChart.destroy(); if (window.reportsByStatusChart) window.reportsByStatusChart.destroy();
                if (window.activitiesDailyChart) window.activitiesDailyChart.destroy(); if (window.activitiesHourlyChart) window.activitiesHourlyChart.destroy(); if (window.activitiesByStaffChart) window.activitiesByStaffChart.destroy();

                window.reportsDailyChart = createChart('reportsDailyChart', 'line', data.reports.daily_labels, data.reports.daily_data, 'Laporan', 'rgba(59, 130, 246, 0.1)');
                window.reportsHourlyChart = createChart('reportsHourlyChart', 'bar', data.reports.hourly_labels, data.reports.hourly_data, 'Jam', 'rgba(14, 165, 233, 0.6)');
                window.reportsByStatusChart = createChart('reportsByStatusChart', 'doughnut', data.reports.status_labels, data.reports.status_data, 'Status', ['#fbbf24', '#34d399', '#f87171']);
                window.activitiesDailyChart = createChart('activitiesDailyChart', 'line', data.activities.daily_labels, data.activities.daily_data, 'Aktivitas', 'rgba(139, 92, 246, 0.1)');
                window.activitiesHourlyChart = createChart('activitiesHourlyChart', 'bar', data.activities.hourly_labels, data.activities.hourly_data, 'Jam', 'rgba(245, 158, 11, 0.6)');
                window.activitiesByStaffChart = createChart('activitiesByStaffChart', 'pie', data.activities.staff_labels, data.activities.staff_data, 'Staf', ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#3b82f6']);
            });

        // --- PDF EXPORT LOGIC (DENGAN GAMBAR DI LAMPIRAN) ---
        const getDataUri = (url) => {
            return new Promise((resolve) => {
                const image = new Image(); image.crossOrigin = "Anonymous";
                image.onload = () => { const canvas = document.createElement('canvas'); canvas.width = image.width; canvas.height = image.height; canvas.getContext('2d').drawImage(image, 0, 0); resolve(canvas.toDataURL('image/jpeg')); };
                image.onerror = () => resolve(null); image.src = url;
            });
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: "landscape" });
            const btn = document.getElementById('btn-export-pdf'); const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner-gap animate-spin"></i> Proses...'; btn.disabled = true;

            try {
                // Header PDF
                doc.setFillColor(59, 130, 246); doc.rect(0, 0, 297, 20, 'F');
                doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.setFont("helvetica", "bold"); doc.text("Laporan Monitoring Lapangan", 14, 13);
                doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text(`Dicetak: ${new Date().toLocaleString('id-ID')}`, 200, 13); doc.setTextColor(0, 0, 0);

                // Tabel Data
                const tableColumns = ["ID", "Waktu", "Tim", "Penerima", "Jarak", "Status", "Keterangan"];
                const tableRows = rawData.map(item => [ item.id, item.tanggal, item.tim, item.penerima, item.jarak + " KM", item.status, item.keterangan ]);
                doc.autoTable({ head: [tableColumns], body: tableRows, startY: 30, theme: 'striped', headStyles: { fillColor: [59, 130, 246], fontStyle: 'bold' }, styles: { fontSize: 9, cellPadding: 3 }, alternateRowStyles: { fillColor: [243, 244, 246] } });

                // Lampiran Gambar (Looping)
                for (let i = 0; i < rawData.length; i++) {
                    const item = rawData[i];
                    if (item.fotoUrl) {
                        const imgData = await getDataUri(item.fotoUrl);
                        if (imgData) {
                            doc.addPage();
                            doc.setFontSize(14); doc.setTextColor(59, 130, 246); doc.text(`Bukti Foto - Laporan #${item.id}`, 14, 20);
                            doc.setFontSize(10); doc.setTextColor(80, 80, 80); doc.text(`Tim: ${item.tim} | Penerima: ${item.penerima}`, 14, 28);
                            const imgProps = doc.getImageProperties(imgData); const pdfWidth = doc.internal.pageSize.getWidth(); const pdfHeight = doc.internal.pageSize.getHeight();
                            const ratio = Math.min((pdfWidth - 40) / imgProps.width, (pdfHeight - 60) / imgProps.height);
                            doc.addImage(imgData, 'JPEG', (pdfWidth - (imgProps.width * ratio)) / 2, 40, imgProps.width * ratio, imgProps.height * ratio);
                        }
                    }
                }
                doc.save("Laporan-Lengkap.pdf");
            } catch (e) { alert("Error export PDF"); console.error(e); } finally { btn.innerHTML = originalText; btn.disabled = false; }
        }

        // --- EXCEL EXPORT LOGIC (DENGAN GAMBAR FISIK) ---
        async function generateExcel() {
            const btn = document.getElementById('btn-export-excel'); const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner-gap animate-spin"></i> Proses...'; btn.disabled = true;

            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Laporan Lapangan');

                // Definisi Kolom
                worksheet.columns = [
                    { header: 'ID', key: 'id', width: 8 }, { header: 'Waktu', key: 'waktu', width: 18 },
                    { header: 'Tim', key: 'tim', width: 15 }, { header: 'Penerima', key: 'penerima', width: 20 },
                    { header: 'Jarak (KM)', key: 'jarak', width: 12 }, { header: 'Status', key: 'status', width: 12 },
                    { header: 'Keterangan', key: 'ket', width: 40 }, { header: 'Bukti Foto', key: 'foto', width: 35 }
                ];

                // Style Header
                worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
                worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } };

                // Loop Data & Masukkan Gambar
                for (let i = 0; i < rawData.length; i++) {
                    const item = rawData[i];
                    const row = worksheet.addRow({
                        id: item.id, waktu: item.tanggal, tim: item.tim, penerima: item.penerima,
                        jarak: parseFloat(item.jarak), status: item.status, ket: item.keterangan, foto: ''
                    });
                    row.height = 90; // Tinggi baris untuk gambar
                    row.alignment = { vertical: 'middle', wrapText: true };

                    if (item.fotoUrl) {
                        try {
                            // Fetch gambar dari URL server
                            const response = await fetch(item.fotoUrl);
                            const buffer = await response.arrayBuffer();
                            const imageId = workbook.addImage({ buffer: buffer, extension: 'jpeg' });
                            // Tempel gambar ke sel (Kolom 7 = H, Baris saat ini)
                            worksheet.addImage(imageId, {
                                tl: { col: 7, row: row.number - 1 }, br: { col: 8, row: row.number }, editAs: 'oneCell'
                            });
                        } catch (err) { console.warn("Gagal fetch gambar Excel:", err); row.getCell('foto').value = "(Gagal muat gambar)"; }
                    } else { row.getCell('foto').value = "(Tidak ada foto)"; }
                }

                // Download File
                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), "Laporan-Lapangan-Bergambar.xlsx");

            } catch (error) { console.error("Excel Error:", error); alert("Gagal export Excel."); } 
            finally { btn.innerHTML = originalText; btn.disabled = false; }
        }
    </script>
</body>
</html>